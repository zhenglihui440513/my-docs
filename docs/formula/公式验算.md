## 原问题

上层
$$
\max_{\epsilon_w}\quad-\epsilon_w p_b\\
\text{s.t.}\quad  (P_l)^2+(Q_l)^2\le(S_{\max})^2\\
1-V_{\text{var}}\le V_b\le 1+V_{\text{var}}
$$

> 其中，由于$p^b_w$是负值，所以最大化一个负数的表达式 ；此外约束还包括了，$P_l$的计算，即load、mt和trade两个部分组成，其中pf2计算利用了ptdf，v的计算利用了M_incident；

下层
$$
\min_{p_i^P,p_j^C,p_w^s,p_w^b}\quad\sum_{i}(a_i^P(p_i^P)^2/2+b_i^Pp_i^P)+\sum_j(a_i^C(p_j^C)^2/2+b_j^Cp_j^C)-\sum_w(c_w+\epsilon_w)p_w^b\\
\text{s.t.} \quad \underline{G_i}\le p_i^P\le\overline{G_i},\forall i\\
\underline{D_j}\le p_j^P\le\overline{D_j},\forall j\\
p_i^P=\sum_{w\in\Omega^P_i}p_w^s,\forall i\\
p_j^C=\sum_{w\in\Omega^C_j}p_w^b,\forall j\\
p_w^s+p_w^b=0,\forall w\\
p_w^s\ge0,p_w^b\le0,\forall w
$$

> 其中，ab都是正值，第三象限开口向上，且消费越多效用值越高；
>
> $c_w=\gamma d_{ij}$是固定的NUC且不计入上层的优化目标当中；
>
> 其中交易量的最值问题，不清楚经过处理和不经过处理是否一样。



## 构造拉格朗日函数

拉格朗日函数
$$
L(p_i^P,p_j^C,p_w^s,p_w^b,\mu,\nu)=\\\sum_{i}(a_i^P(p_i^P)^2/2+b_i^Pp_i^P)+\sum_j(a_i^C(p_j^C)^2/2+b_j^Cp_j^C)-\sum_w(c_w+\epsilon_w)p_w^b+\\
\sum_i(\mu^1_i(p_i^P-\overline{G_i})+
\mu^2_i(\underline{G_i}-p_i^P))+\\
\sum_j(\mu^3_j(p_j^C-\overline{D_j})+
\mu^4_j(\underline{D_j}-p_j^C))+\\
\sum_i\nu^1_i(p_i^P-\sum_{w\in\Omega^P_i}p_w^s)+
\sum_j\nu_j^2(p_j^C-\sum_{\omega\in\Omega_j^C}p_w^b)-
\sum_w\nu_w^3(p_w^s+p_w^b)
$$

## KKT条件（单层问题）

强对偶约束对应目标函数
$$
\sum_{i}(a_i^P(p_i^P)^2/2+b_i^Pp_i^P)+\sum_j(a_i^C(p_j^C)^2/2+b_j^Cp_j^C)-\sum_w(c_w+\epsilon_w)p_w^b=\\
\sum_i(-\mu_i^1\overline{G_i}+\mu_i^2\underline{G_i})+
\sum_j(-\mu_j^3\overline{D_j}+\mu_j^4\underline{D_j})
$$

> $-\epsilon_wp_w^b$是下层的最小化目标，也是上层的最大化目标，因此上层的最小化目标是$\epsilon_wp_w^b$

$$
\epsilon_wp_w^b=\sum_{i}(a_i^P(p_i^P)^2/2+b_i^Pp_i^P)+\sum_j(a_i^C(p_j^C)^2/2+b_j^Cp_j^C)-\sum_wc_wp_w^b+\\
\sum_i(\mu_i^1\overline{G_i}-\mu_i^2\underline{G_i})+
\sum_j(\mu_j^3\overline{D_j}-\mu_j^4\underline{D_j})
$$



大M法对应不等式约束
$$
0\le\mu_i^1\le M\varsigma_i^1,\forall i\\
0\le(\overline{G_i}-p_i^P)\le M(1-\varsigma_i^1),\forall i\\
0\le\mu_i^2\le M\varsigma_i^2,\forall i\\
0\le(p_i^P-\underline{G_i})\le M(1-\varsigma_i^2),\forall i\\
0\le\mu_j^3\le M\varsigma_j^3,\forall j\\
0\le(\overline{D_j}-p_j^C)\le M(1-\varsigma_j^3),\forall j\\
0\le\mu_j^4\le M\varsigma_j^4,\forall j\\
0\le(p_j^C-\underline{D_j})\le M(1-\varsigma_j^4),\forall j\\
$$

> 其中$\varsigma$是引入的0/1变量；

等式约束
$$
p_i^P-\sum_{w\in\Omega^P_i}p_w^s=0\\
p_j^C-\sum_{\omega\in\Omega_j^C}p_w^b=0\\
p_w^s+p_w^b=0\\
$$
一阶最优条件
$$
\frac{\partial L}{\partial p_i^P}=a_i^Pp_i^P+b_i^P+\mu_i^1-\mu_i^2+\nu_i^1=0\\
\frac{\partial L}{\partial p_j^C}=a_j^Cp_j^C+b_j^C+\mu_j^3-\mu_j^4+\nu_j^2=0\\
\frac{\partial L}{\partial p_w^s}=-\nu_i^1|_{w\in\Omega^P_i}-\nu_w^3=0\\
\frac{\partial L}{\partial p_w^b}=-\nu_j^2|_{w\in\Omega^C_j}-\nu_w^3-c_w-\epsilon_w=0
$$
